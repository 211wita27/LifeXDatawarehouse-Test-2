<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Datensatz anlegen</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f4f4f4}
        .container{max-width:900px;margin:2rem auto;background:#fff;padding:2rem;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
        fieldset{border:none;margin:0;padding:0}
        label{display:block;margin-top:1rem}
        input,select,button{padding:.4rem;font-size:1rem;margin-top:.3rem}
        button{cursor:pointer;margin-top:1.2rem}
        .success{color:green}.error{color:red}
        .hidden{display:none}
        .entity-context{margin-top:1.5rem;padding:1rem;background:#e8f1ff;border-left:4px solid #2c64b5;border-radius:4px}
        .entity-hint{margin:0;font-weight:600;color:#1f3d7a}
    </style>
</head>
<body>
<a href="#main" class="skip-link">Zum Inhalt springen</a>

<header>
    <img src="/img/LifeXDatawarehouseLogo.png" alt="">
    <nav aria-label="Hauptnavigation">
        <a href="/index.html">Dashboard</a>
        <a href="/create.html" aria-current="page">Daten anlegen</a>
        <a href="/reports.html">Reports</a>
    </nav>
</header>

<main id="main" class="container" aria-live="polite">
    <h1>Datensatz anlegen</h1>

    <!-- Schritt 1 -->
    <fieldset id="step1">
        <label for="entity">Welche Entität möchtest du anlegen?</label>
        <select id="entity">
            <option>Account</option><option>Project</option><option>Site</option>
            <option>Server</option><option>WorkingPosition</option><option>Radio</option>
            <option>AudioDevice</option><option>PhoneIntegration</option><option>DeploymentVariant</option>
        </select>
        <button onclick="next()">Weiter</button>
    </fieldset>

    <!-- Schritt 2 -->
    <section id="entityContext" class="entity-context hidden" aria-live="assertive" aria-atomic="true" aria-hidden="true">
        <p id="entityHint" class="entity-hint"></p>
    </section>
    <form id="dynamicForm" class="hidden" onsubmit="submitForm(event)"></form>

    <div id="result" role="status" aria-live="polite" aria-atomic="true"></div>
</main>

<script>
    function back(){
        dynamicForm.classList.add('hidden'); step1.classList.remove('hidden');
        dynamicForm.innerHTML=''; result.textContent='';
        if(window.entityContext){
            entityContext.classList.add('hidden');
            entityContext.setAttribute('aria-hidden','true');
        }
        if(window.entityHint){
            entityHint.textContent='';
        }
    }
    function next(){
        buildForm(entity.value); step1.classList.add('hidden');
        dynamicForm.classList.remove('hidden');
    }

    const add=(id,lbl,req=true)=>`<label for="${id}">${lbl}<input id="${id}" ${req?'required':''}></label>`;
    const addSel=(id,lbl,opts,req=true)=>{
        const empty = req ? '' : `<option value=""></option>`;
        return `<label for="${id}">${lbl}<select id="${id}" ${req?'required':''}>${empty}
      ${opts.map(o=>`<option value="${o}">${o}</option>`).join('')}
    </select></label>`;
    };

    const pick = (obj,...keys)=>{
        for(const key of keys){
            if(obj && obj[key]!==undefined && obj[key]!==null) return obj[key];
        }
        return undefined;
    };

    const formatLabel = (name,value)=>{
        if(!value) return '';
        if(!name) return value;
        const short = String(value).split('-')[0];
        return `${name} (${short})`;
    };

    const asyncSources = {
        accounts:{
            url:'/accounts',
            map:item=>{
                const value = pick(item,'accountID','accountId','AccountID');
                const name = pick(item,'accountName','AccountName');
                return value ? {value, label: formatLabel(name,value)} : null;
            }
        },
        addresses:{
            url:'/addresses',
            map:item=>{
                const value = pick(item,'addressID','addressId','AddressID');
                const street = pick(item,'street','Street');
                const city = pick(item,'cityID','CityID');
                const label = street || city ? `${[street,city].filter(Boolean).join(', ')} (${String(value).split('-')[0]})` : value;
                return value ? {value, label} : null;
            }
        },
        projects:{
            url:'/projects',
            map:item=>{
                const value = pick(item,'projectID','projectId','ProjectID');
                const name = pick(item,'projectName','ProjectName');
                return value ? {value, label: formatLabel(name,value)} : null;
            }
        },
        sites:{
            url:'/sites',
            map:item=>{
                const value = pick(item,'siteID','siteId','SiteID');
                const name = pick(item,'siteName','SiteName');
                return value ? {value, label: formatLabel(name,value)} : null;
            }
        },
        clients:{
            url:siteId=>siteId?`/clients?siteId=${encodeURIComponent(siteId)}`:null,
            map:item=>{
                const value = pick(item,'clientID','clientId','ClientID');
                const name = pick(item,'clientName','ClientName');
                return value ? {value, label: formatLabel(name,value)} : null;
            }
        }
    };

    let asyncSelectConfigs = {};

    const entityMessages = {
        Account: 'Du legst gerade einen Account an.',
        Project: 'Du legst gerade ein Projekt an.',
        Site: 'Du legst gerade einen Standort (Site) an.',
        Server: 'Du legst gerade einen Server an.',
        WorkingPosition: 'Du legst gerade eine Arbeitsstation an.',
        Radio: 'Du legst gerade ein Funkgerät an.',
        AudioDevice: 'Du legst gerade ein Audiogerät an.',
        PhoneIntegration: 'Du legst gerade eine Telefonintegration an.',
        DeploymentVariant: 'Du legst gerade eine Deployment-Variante an.'
    };

    function renderAsyncSelect(id,label,sourceKey,options={}){
        const {required=true, allowManual=true, placeholder='Bitte auswählen', dependsOn=null, emptyText='Keine Einträge vorhanden'} = options;
        asyncSelectConfigs[id]={sourceKey, required, allowManual, placeholder, dependsOn, emptyText};
        const manualToggle = allowManual ? `<button type="button" class="toggle-manual" data-field="${id}">Freitext eingeben</button>` : '';
        const manualInput = allowManual ? `<input type="text" id="${id}-manual" class="hidden" placeholder="UUID eingeben" ${required?'required':''}>` : '';
        return `<label class="async-label">${label}
            <div class="async-select" data-field="${id}" data-source="${sourceKey}" data-required="${required}"${dependsOn?` data-depends-on="${dependsOn}"`:''}>
                <select id="${id}-select" ${required?'required':''}>
                    <option value="">${placeholder}</option>
                </select>
                ${manualInput}
                <input type="hidden" id="${id}">
                ${manualToggle}
            </div>
        </label>`;
    }

    async function fetchJson(url){
        if(!url) return [];
        const res = await fetch(url);
        if(res.status===204) return [];
        if(!res.ok) throw new Error(`Fetch failed: ${res.status}`);
        try{
            return await res.json();
        }catch{
            return [];
        }
    }

    function populateOptions(select,entries,options={}){
        const {placeholder='Bitte auswählen', allowEmpty=false}=options;
        const currentValue = select.value;
        select.innerHTML='';
        if(placeholder!==null){
            const opt=document.createElement('option');
            opt.value='';
            opt.textContent=placeholder;
            select.appendChild(opt);
        }
        entries.filter(Boolean).forEach(entry=>{
            const opt=document.createElement('option');
            opt.value=entry.value;
            opt.textContent=entry.label || entry.value;
            select.appendChild(opt);
        });
        if(entries.length>0 && entries.some(e=>e && e.value===currentValue)){
            select.value=currentValue;
        }else if(allowEmpty){
            select.value='';
        }else{
            select.value='';
        }
    }

    function updateValueProxy(id,value){
        const hidden=document.getElementById(id);
        if(!hidden) return;
        const newValue=value??'';
        if(hidden.value===newValue) return;
        hidden.value=newValue;
        hidden.dispatchEvent(new CustomEvent('value-changed',{bubbles:true,detail:{value:newValue}}));
    }

    function getAsyncContainer(id){
        return dynamicForm.querySelector(`.async-select[data-field="${id}"]`);
    }

    function setManualMode(id,mode){
        const container=getAsyncContainer(id);
        if(!container) return;
        const select=container.querySelector('select');
        const manual=container.querySelector(`#${id}-manual`);
        const toggle=container.querySelector('.toggle-manual');
        const required=container.dataset.required==='true';
        if(!manual){
            container.dataset.mode='select';
            select?.classList.remove('hidden');
            if(select && required) select.setAttribute('required','');
            return;
        }
        if(mode==='manual'){
            select?.classList.add('hidden');
            if(select) select.removeAttribute('required');
            select?.setAttribute('aria-hidden','true');
            if(select) select.disabled=true;
            manual.classList.remove('hidden');
            if(required) manual.setAttribute('required',''); else manual.removeAttribute('required');
            if(toggle) toggle.textContent='Aus Liste wählen';
            container.dataset.mode='manual';
            updateValueProxy(id,manual.value?.trim()||'');
        }else{
            manual.classList.add('hidden');
            manual.removeAttribute('required');
            select?.classList.remove('hidden');
            if(select) {
                select.removeAttribute('aria-hidden');
                if(required) select.setAttribute('required','');
                select.disabled = select.options.length===0;
            }
            if(toggle) toggle.textContent='Freitext eingeben';
            container.dataset.mode='select';
            updateValueProxy(id,select?select.value:'');
        }
    }

    async function loadOptionsForField(id){
        const config=asyncSelectConfigs[id];
        if(!config) return;
        const container=getAsyncContainer(id);
        if(!container) return;
        const select=container.querySelector('select');
        const manual=container.querySelector(`#${id}-manual`);
        if(!select) return;
        const dependencyId=config.dependsOn;
        const dependencyValue=dependencyId?document.getElementById(dependencyId)?.value?.trim():undefined;
        if(dependencyId && !dependencyValue){
            select.innerHTML='';
            populateOptions(select,[],{placeholder:'Bitte zuerst eine Site wählen',allowEmpty:true});
            select.disabled=true;
            if(manual){
                manual.value='';
                if(container.dataset.mode!=='manual') updateValueProxy(id,'');
            }
            return;
        }

        const source=asyncSources[config.sourceKey];
        if(!source){
            select.innerHTML='';
            select.disabled=true;
            if(manual){
                manual.value='';
                if(container.dataset.mode!=='manual') updateValueProxy(id,'');
                if(config.allowManual!==false) setManualMode(id,'manual');
            }
            return;
        }

        select.disabled=true;
        select.innerHTML=`<option value="">Lade Daten…</option>`;
        try{
            const url=typeof source.url==='function'?source.url(dependencyValue):source.url;
            const data=await fetchJson(url);
            const entries=(Array.isArray(data)?data:[]).map(source.map).filter(Boolean);
            const placeholderText = entries.length===0 ? (config.emptyText||config.placeholder) : config.placeholder;
            populateOptions(select,entries,{placeholder:placeholderText,allowEmpty:!config.required});
            select.disabled=entries.length===0;
            if(container.dataset.mode!=='manual'){
                select.value='';
                updateValueProxy(id,'');
            }
            if(entries.length===0 && config.allowManual!==false){
                if(manual){
                    manual.value='';
                    setManualMode(id,'manual');
                }
            }else if(container.dataset.mode!=='manual'){
                setManualMode(id,'select');
            }
        }catch(err){
            console.error(err);
            populateOptions(select,[],{placeholder:'Fehler beim Laden'});
            select.disabled=true;
            if(config.allowManual!==false){
                setManualMode(id,'manual');
            }
        }
    }

    function initializeAsyncSelects(form){
        Object.keys(asyncSelectConfigs).forEach(id=>{
            const container=form.querySelector(`.async-select[data-field="${id}"]`);
            if(!container) return;
            const select=container.querySelector('select');
            const manual=container.querySelector(`#${id}-manual`);
            const toggle=container.querySelector('.toggle-manual');
            const hidden=form.querySelector(`#${id}`);
            if(hidden) hidden.value='';
            container.dataset.mode='select';
            if(select){
                select.addEventListener('change',()=>{
                    if(container.dataset.mode!=='manual'){
                        updateValueProxy(id,select.value);
                    }
                });
            }
            if(manual){
                manual.addEventListener('input',()=>{
                    if(container.dataset.mode==='manual'){
                        updateValueProxy(id,manual.value.trim());
                    }
                });
            }
            if(toggle){
                toggle.addEventListener('click',()=>{
                    setManualMode(id,container.dataset.mode==='manual'?'select':'manual');
                });
            }
            if(manual && container.dataset.required==='true'){
                manual.removeAttribute('required');
            }
            setManualMode(id,'select');
        });

        Object.entries(asyncSelectConfigs).forEach(([id,config])=>{
            if(config.dependsOn){
                const dep=document.getElementById(config.dependsOn);
                if(dep){
                    dep.addEventListener('value-changed',()=>loadOptionsForField(id));
                }
            }
            loadOptionsForField(id);
        });
    }

    function buildForm(t){
        const f=dynamicForm; f.dataset.type=t; let h='';
        asyncSelectConfigs = {};
        const message = entityMessages[t] || `Du legst gerade einen Datensatz der Entität ${t} an.`;
        if(window.entityHint && window.entityContext){
            entityHint.textContent = message;
            entityContext.classList.remove('hidden');
            entityContext.removeAttribute('aria-hidden');
        }
        switch(t){
            case 'Account':
                h+= add('name','Name')
                    + add('contact','Kontaktperson')
                    + add('email','E-Mail')
                    + add('phone','Telefon')
                    + add('vat','USt-ID')
                    + add('country','Land');
                break;

            case 'Project':
                h+= add('sap','SAP-ID')
                    + add('pname','Projektname')
                    + add('variantId','DeploymentVariantID (UUID)')
                    + add('bundle','Bundle-Type',false)
                    + renderAsyncSelect('accId','Account auswählen','accounts')
                    + renderAsyncSelect('addrId','Adresse auswählen','addresses');
                break;

            case 'Site':
                h+= renderAsyncSelect('pId','Project auswählen','projects')
                    + add('name','Site-Name')
                    + renderAsyncSelect('addrId','Adresse auswählen','addresses')
                    + add('zone','FireZone')
                    + add('tenant','TenantCount');
                break;

            case 'Server':
                h+= renderAsyncSelect('siteId','Site auswählen','sites')
                    + add('name','Servername')
                    + add('brand','Marke')
                    + add('serial','Serien-Nr.')
                    + add('os','Betriebssystem')
                    + add('patch','Patch-Level')
                    + addSel('vplat','Virtual-Platform',['BareMetal','HyperV','vSphere'])
                    + add('vver','Virtual-Version',false)
                    + addSel('ha','HighAvailability',['true','false']);
                break;

            case 'WorkingPosition':
                h+= renderAsyncSelect('siteId','Site auswählen','sites')
                    + add('name','Client-Name')
                    + add('brand','Marke')
                    + add('serial','Serien-Nr.')
                    + add('os','OS')
                    + add('patch','Patch-Level')
                    + addSel('install','InstallType',['LOCAL','BROWSER']);
                break;

            case 'Radio':
                h+= renderAsyncSelect('siteId','Site auswählen','sites')
                    + add('brand','Marke')
                    + add('serial','Serien-Nr.')
                    + addSel('mode','Mode',['Analog','Digital'])
                    + addSel('standard','Digital-Standard',['Airbus','Motorola','ESN','P25','Polycom','Teltronics'],false)
                    + renderAsyncSelect('client','AssignedClientID (UUID)','clients',{required:false, placeholder:'Client auswählen (optional)', dependsOn:'siteId'});
                break;

            case 'AudioDevice':
                h+= renderAsyncSelect('client','Client auswählen','clients',{placeholder:'Client auswählen'})
                    + add('brand','Marke')
                    + add('serial','Serien-Nr.')
                    + add('fw','Firmware')
                    + addSel('dtype','DeviceType',['HEADSET','SPEAKER','MIC']);
                break;

            case 'PhoneIntegration':
                h+= renderAsyncSelect('client','Client auswählen','clients',{placeholder:'Client auswählen'})
                    + addSel('type','PhoneType',['Emergency','NonEmergency','Both'])
                    + add('brand','Marke')
                    + add('serial','Serien-Nr.')
                    + add('fw','Firmware');
                break;

            case 'DeploymentVariant':
                h+= add('variantCode','VariantCode')
                    + add('variantName','VariantName')
                    + add('description','Description',false)
                    + addSel('active','IsActive',['true','false']);
                break;
        }
        f.innerHTML = h + `<button>Speichern</button> <button type="button" onclick="back()">Zurück</button>`;
        initializeAsyncSelects(f);
        if(t==='Radio') wireRadioLogic();
    }

    function wireRadioLogic(){
        const m = document.getElementById('mode');
        const s = document.getElementById('standard');
        if(!m || !s) return;
        const update = ()=>{
            const disable = (m.value==='Analog');
            s.disabled = disable;
            if(disable){ s.value=''; }
        };
        m.addEventListener('change', update);
        update();
    }

    const v=id=>document.getElementById(id)?.value?.trim();
    async function submitForm(e){
        e.preventDefault();
        const t=e.target.dataset.type; result.textContent=''; result.setAttribute('aria-busy','true');
        let url='',p={};

        switch(t){
            case 'Account':
                url='/accounts';
                p={
                    accountName: v('name'),
                    contactName: v('contact'),
                    contactEmail: v('email'),
                    contactPhone: v('phone'),
                    vatNumber: v('vat'),
                    country: v('country')
                };
                break;

            case 'Project':
                url='/projects';
                p={
                    projectSAPID: v('sap'),
                    projectName: v('pname'),
                    deploymentVariantID: v('variantId'),
                    bundleType: v('bundle') || null,
                    accountID: v('accId'),
                    addressID: v('addrId')
                };
                break;

            case 'Site':
                url='/sites';
                p={
                    projectID: v('pId'),
                    siteName: v('name'),
                    addressID: v('addrId'),
                    fireZone: v('zone'),
                    tenantCount: v('tenant') ? Number(v('tenant')) : null
                };
                break;

            case 'Server':
                url='/servers';
                p={
                    siteID: v('siteId'),
                    serverName: v('name'),
                    serverBrand: v('brand'),
                    serverSerialNr: v('serial'),
                    serverOS: v('os'),
                    patchLevel: v('patch'),
                    virtualPlatform: v('vplat'),
                    virtualVersion: v('vver') || null,
                    highAvailability: v('ha') === 'true'
                };
                break;

            case 'WorkingPosition': // -> Clients
                url='/clients';
                p={
                    siteID: v('siteId'),
                    clientName: v('name'),
                    clientBrand: v('brand'),
                    clientSerialNr: v('serial'),
                    clientOS: v('os'),
                    patchLevel: v('patch'),
                    installType: v('install')
                };
                break;

            case 'Radio':
                url='/radios';
                p={
                    siteID: v('siteId'),
                    radioBrand: v('brand'),
                    radioSerialNr: v('serial'),
                    mode: v('mode'),
                    digitalStandard: v('standard') || null,
                    assignedClientID: v('client') || null
                };
                break;

            case 'AudioDevice':
                url='/audio';
                p={
                    clientID: v('client'),
                    audioDeviceBrand: v('brand'),
                    deviceSerialNr: v('serial'),
                    audioDeviceFirmware: v('fw'),
                    deviceType: v('dtype')
                };
                break;

            case 'PhoneIntegration':
                url='/phones';
                p={
                    clientID: v('client'),
                    phoneType: v('type'),
                    phoneBrand: v('brand'),
                    phoneSerialNr: v('serial'),
                    phoneFirmware: v('fw')
                };
                break;

            case 'DeploymentVariant':
                url='/deployment-variants';
                p={
                    variantCode: v('variantCode'),
                    variantName: v('variantName'),
                    description: v('description') || null,
                    active: v('active') === 'true'
                };
                break;
        }

        try{
            const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)});
            if(r.ok){result.innerHTML=`<p class="success">✔ ${t} angelegt.</p>`;e.target.reset();}
            else   {result.innerHTML=`<p class="error" role="alert">${await r.text()}</p>`;}
        }catch{
            result.innerHTML=`<p class="error" role="alert">Netzwerkfehler.</p>`;
        }finally{
            result.removeAttribute('aria-busy');
        }
    }
</script>
</body>
</html>
