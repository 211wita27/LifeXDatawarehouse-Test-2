<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Datensatz anlegen</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f4f4f4}
        .container{max-width:900px;margin:2rem auto;background:#fff;padding:2rem;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
        fieldset{border:none;margin:0;padding:0}
        label{display:flex;align-items:center;gap:.6rem;margin-top:1rem;flex-wrap:wrap}
        input,select,button{padding:.4rem;font-size:1rem;margin-top:.3rem}
        button{cursor:pointer;margin-top:1.2rem}
        .success{color:green}.error{color:red}
        .hidden{display:none}
        .entity-context{margin-top:1.5rem;padding:1rem;background:#e8f1ff;border-left:4px solid #2c64b5;border-radius:4px}
        .entity-hint{margin:0;font-weight:600;color:#1f3d7a}
    </style>
</head>
<body>
<a href="#main" class="skip-link">Zum Inhalt springen</a>

<header>
    <img src="/img/LifeXDatawarehouseLogo.png" alt="">
    <nav aria-label="Hauptnavigation">
        <a href="/index.html">Dashboard</a>
        <a href="/create.html" aria-current="page">Daten anlegen</a>
        <a href="/reports.html">Reports</a>
    </nav>
</header>

<main id="main" class="container" aria-live="polite">
    <h1>Datensatz anlegen</h1>

    <!-- Schritt 1 -->
    <fieldset id="step1">
        <label for="entity">Welche Entität möchtest du anlegen?</label>
        <select id="entity">
            <option value="Account">Account</option>
            <option value="Address">Address</option>
            <option value="AudioDevice">AudioDevice</option>
            <option value="City">City</option>
            <option value="Country">Country</option>
            <option value="DeploymentVariant">DeploymentVariant</option>
            <option value="InstalledSoftware">InstalledSoftware</option>
            <option value="PhoneIntegration">PhoneIntegration</option>
            <option value="Project">Project</option>
            <option value="Radio">Radio</option>
            <option value="Server">Server</option>
            <option value="ServiceContract">ServiceContract</option>
            <option value="Site">Site</option>
            <option value="Software">Software</option>
            <option value="UpgradePlan">UpgradePlan</option>
            <option value="WorkingPosition">Client (WorkingPosition)</option>
        </select>
        <button onclick="next()">Weiter</button>
    </fieldset>

    <!-- Schritt 2 -->
    <section id="entityContext" class="entity-context hidden" aria-live="assertive" aria-atomic="true" aria-hidden="true">
        <p id="entityHint" class="entity-hint"></p>
    </section>
    <form id="dynamicForm" class="hidden" onsubmit="submitForm(event)"></form>

    <div id="result" role="status" aria-live="polite" aria-atomic="true"></div>
</main>

<script src="/js/select-filter.js"></script>

<script>
    function back(){
        dynamicForm.classList.add('hidden'); step1.classList.remove('hidden');
        dynamicForm.innerHTML=''; result.textContent='';
        if(window.entityContext){
            entityContext.classList.add('hidden');
            entityContext.setAttribute('aria-hidden','true');
        }
        if(window.entityHint){
            entityHint.textContent='';
        }
    }
    function next(){
        buildForm(entity.value); step1.classList.add('hidden');
        dynamicForm.classList.remove('hidden');
    }

    const escapeAttr=value=>String(value)
        .replace(/&/g,'&amp;')
        .replace(/"/g,'&quot;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;');

    const renderAttributes=attrs=>Object.entries(attrs)
        .map(([key,value])=>{
            if(value===undefined||value===null||value===false) return '';
            if(value===true) return ` ${key}`;
            return ` ${key}="${escapeAttr(value)}"`;
        }).join('');

    const add=(id,lbl,opts=true)=>{
        let config;
        if(typeof opts==='boolean'){
            config={required:opts};
        }else{
            config={...opts};
            if(config.required===undefined) config.required=true;
        }

        const attributes={
            id,
            name:config?.name||id,
            type:config?.type||'text'
        };

        const optionalKeys=['placeholder','pattern','maxlength','minlength','min','max','step','autocomplete','inputmode','list'];
        optionalKeys.forEach(key=>{
            if(config&&config[key]!==undefined&&config[key]!==null){
                attributes[key]=config[key];
            }
        });

        if(config&&config.disabled) attributes.disabled=true;
        if(config&&config.readonly) attributes.readonly=true;
        if(config&&config.className) attributes.class=config.className;
        if(config&&config.class) attributes.class=config.class;
        if(config&&config.value!==undefined&&config.value!==null) attributes.value=config.value;
        if(config&&config.dataset){
            Object.entries(config.dataset).forEach(([key,value])=>{
                if(value!==undefined&&value!==null){
                    attributes[`data-${key}`]=value;
                }
            });
        }
        if(!config||config.required!==false) attributes.required=true;

        const extra=config&&config.attrs?` ${config.attrs.trim()}`:'';
        return `<label for="${id}">${lbl}<input${renderAttributes(attributes)}${extra}></label>`;
    };

    const toChoices=choices=>{
        if(!Array.isArray(choices)) return [];
        return choices.map(choice=>{
            if(choice&&typeof choice==='object'){
                return {value:choice.value, label:choice.label??choice.value};
            }
            return {value:choice, label:choice};
        });
    };

    const addSel=(id,lbl,choices,opts=true)=>{
        const config=(opts&&typeof opts==='object'&&!Array.isArray(opts))?{...opts}:{required:opts};
        if(config.required===undefined) config.required=true;
        const placeholder=config.placeholder??'Bitte auswählen';
        const values=Array.isArray(choices)?toChoices(choices):toChoices([]);
        const selectAttrs=renderAttributes({id,name:id,required:config.required!==false});
        const optionsHtml=values.map(o=>`<option value="${escapeAttr(o.value)}">${escapeAttr(o.label)}</option>`).join('');
        return `<label for="${id}">${lbl}<select${selectAttrs}><option value="">${escapeAttr(placeholder)}</option>${optionsHtml}</select></label>`;
    };

    const pick = (obj,...keys)=>{
        if(!obj) return undefined;
        const entries = Object.keys(obj);
        for(const key of keys){
            if(key==null) continue;
            if(obj[key]!==undefined && obj[key]!==null) return obj[key];
            const match = entries.find(k=>k.toLowerCase()===String(key).toLowerCase());
            if(match && obj[match]!==undefined && obj[match]!==null) return obj[match];
        }
        return undefined;
    };

    const formatLabel = (name,value)=>{
        if(!value) return '';
        if(!name) return value;
        const short = String(value).split('-')[0];
        return `${name} (${short})`;
    };

    const asyncSources = {
        accounts:{
            url:'/accounts',
            map:item=>{
                const value = pick(item,'accountID','accountId','AccountID');
                const name = pick(item,'accountName','AccountName');
                return value ? {value, label: formatLabel(name,value)} : null;
            }
        },
        addresses:{
            url:'/addresses',
            map:item=>{
                const value = pick(item,'addressID','addressId','AddressID');
                const street = pick(item,'street','Street');
                const city = pick(item,'cityID','CityID');
                const label = street || city ? `${[street,city].filter(Boolean).join(', ')} (${String(value).split('-')[0]})` : value;
                return value ? {value, label, cityID: pick(item,'cityID','CityID')} : null;
            }
        },
        projects:{
            url:accountId=>accountId?`/projects?accountId=${encodeURIComponent(accountId)}`:'/projects',
            map:item=>{
                const value = pick(item,'projectID','projectId','ProjectID');
                const name = pick(item,'projectName','ProjectName');
                const account = pick(item,'accountID','AccountID');
                return value ? {value, label: formatLabel(name,value), accountID: account} : null;
            }
        },
        sites:{
            url:projectId=>projectId?`/sites?projectId=${encodeURIComponent(projectId)}`:'/sites',
            map:item=>{
                const value = pick(item,'siteID','siteId','SiteID');
                const name = pick(item,'siteName','SiteName');
                const project = pick(item,'projectID','ProjectID');
                return value ? {value, label: formatLabel(name,value), projectID: project} : null;
            }
        },
        clients:{
            url:siteId=>siteId?`/clients?siteId=${encodeURIComponent(siteId)}`:null,
            map:item=>{
                const value = pick(item,'clientID','clientId','ClientID');
                const name = pick(item,'clientName','ClientName');
                return value ? {value, label: formatLabel(name,value), siteID: pick(item,'siteID','SiteID')} : null;
            }
        },
        countries:{
            url:'/table/country',
            map:item=>{
                const raw = pick(item,'countryCode','CountryCode','COUNTRYCODE');
                if(!raw) return null;
                const value=String(raw).toUpperCase();
                const name = pick(item,'countryName','CountryName','COUNTRYNAME');
                const label = name ? `${name} (${value})` : value;
                return {value, label};
            }
        },
        cities:{
            url:'/table/city',
            map:item=>{
                const value = pick(item,'cityID','CityID','CITYID');
                if(!value) return null;
                const name = pick(item,'cityName','CityName','CITYNAME');
                const country = pick(item,'countryCode','CountryCode','COUNTRYCODE');
                const countryCode = country ? String(country).toUpperCase() : undefined;
                const labelParts = [name, countryCode].filter(Boolean);
                const short = String(value).split('-')[0];
                const label = labelParts.length>0 ? `${labelParts.join(' • ')} (${short})` : String(value);
                return {value, label, countryCode};
            }
        },
        software:{
            url:'/table/software',
            map:item=>{
                const value = pick(item,'softwareID','SoftwareID','SOFTWAREID');
                if(!value) return null;
                const name = pick(item,'name','Name');
                const release = pick(item,'release','Release');
                const labelParts = [name, release].filter(Boolean).join(' • ');
                const short = String(value).split('-')[0];
                const label = labelParts ? `${labelParts} (${short})` : String(value);
                return {value, label};
            }
        },
        deploymentVariants:{
            url:'/deployment-variants',
            map:item=>{
                const value = pick(item,'variantID','variantId','VariantID');
                if(!value) return null;
                const code = pick(item,'variantCode','VariantCode');
                const name = pick(item,'variantName','VariantName');
                const parts = [code, name].filter(Boolean);
                const label = parts.length>0 ? parts.join(' – ') : String(value);
                return {value, label};
            }
        }
    };

    let asyncSelectConfigs = {};

    const entityMessages = {
        Account: 'Du legst gerade einen Account an.',
        Address: 'Du legst gerade eine Adresse an.',
        AudioDevice: 'Du legst gerade ein Audiogerät an.',
        City: 'Du legst gerade eine Stadt an.',
        Country: 'Du legst gerade ein Land an.',
        DeploymentVariant: 'Du legst gerade eine Deployment-Variante an.',
        InstalledSoftware: 'Du legst gerade eine Software-Installation an.',
        PhoneIntegration: 'Du legst gerade eine Telefonintegration an.',
        Project: 'Du legst gerade ein Projekt an.',
        Radio: 'Du legst gerade ein Funkgerät an.',
        Server: 'Du legst gerade einen Server an.',
        ServiceContract: 'Du legst gerade einen Servicevertrag an.',
        Site: 'Du legst gerade einen Standort (Site) an.',
        Software: 'Du legst gerade einen Software-Datensatz an.',
        UpgradePlan: 'Du planst gerade ein Software-Upgrade.',
        WorkingPosition: 'Du legst gerade eine Arbeitsstation (Client) an.'
    };

    function shortContextId(value){
        if(value===undefined || value===null) return '';
        const str=String(value).trim();
        if(!str) return '';
        const uuidPattern=/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;
        if(uuidPattern.test(str)){
            const idx=str.lastIndexOf('-');
            if(idx!==-1 && idx<str.length-1){
                const last=str.slice(idx+1).replace(/^0+/,'');
                return `#${last||'0'}`;
            }
        }
        return str.startsWith('#')?str:`#${str}`;
    }

    function showEntityMessage(entityKey, context={}){
        if(!window.entityHint || !window.entityContext) return;
        const base=entityMessages[entityKey]||`Du legst gerade einen Datensatz der Entität ${entityKey} an.`;
        const parts=[];
        if(context.accountId) parts.push(`Account ${shortContextId(context.accountId)}`);
        if(context.projectId) parts.push(`Project ${shortContextId(context.projectId)}`);
        if(context.siteId) parts.push(`Site ${shortContextId(context.siteId)}`);
        if(context.clientId) parts.push(`Client ${shortContextId(context.clientId)}`);
        let message=base;
        if(parts.length){
            const trimmed=base.endsWith('.')?base.slice(0,-1):base;
            message=`${trimmed} für ${parts.join(' und ')} an.`;
        }
        entityHint.textContent=message;
        entityContext.classList.remove('hidden');
        entityContext.removeAttribute('aria-hidden');
    }

    function renderAsyncSelect(id,label,sourceKey,options={}){
        const {required=true, allowManual=true, placeholder='Bitte auswählen', dependsOn=null, emptyText='Keine Einträge vorhanden', filter=null} = options;
        asyncSelectConfigs[id]={sourceKey, required, allowManual, placeholder, dependsOn, emptyText, filter};
        const manualToggle = allowManual ? `<button type="button" class="toggle-manual" data-field="${id}">Freitext eingeben</button>` : '';
        const manualInput = allowManual ? `<input type="text" id="${id}-manual" class="hidden" placeholder="UUID eingeben" ${required?'required':''}>` : '';
        return `<label class="async-label">${label}
            <div class="async-select" data-field="${id}" data-source="${sourceKey}" data-required="${required}"${dependsOn?` data-depends-on="${dependsOn}"`:''}>
                <select id="${id}-select" ${required?'required':''}>
                    <option value="">${placeholder}</option>
                </select>
                ${manualInput}
                <input type="hidden" id="${id}">
                ${manualToggle}
            </div>
        </label>`;
    }

    async function fetchJson(url){
        if(!url) return [];
        const res = await fetch(url);
        if(res.status===204) return [];
        if(!res.ok) throw new Error(`Fetch failed: ${res.status}`);
        try{
            return await res.json();
        }catch{
            return [];
        }
    }

    function notifySelectOptions(select, detail={}){
        if(!select) return;
        const rawOptions = Array.isArray(detail.options) ? detail.options : [];
        const normalizedOptions = rawOptions
            .map(entry => entry ? {
                value: entry.value!=null?String(entry.value):'',
                label: entry.label!=null?String(entry.label):String(entry.value??''),
                disabled: entry.disabled ?? false
            } : null)
            .filter(Boolean);
        const payload = {
            options: normalizedOptions,
            placeholder: detail.placeholder ?? '',
            hasPlaceholder: detail.hasPlaceholder !== false
        };
        select.dispatchEvent(new CustomEvent('options-populated',{detail:payload}));
    }

    function populateOptions(select,entries,options={}){
        const {placeholder='Bitte auswählen', allowEmpty=false}=options;
        const currentValue = select.value;
        select.innerHTML='';
        if(placeholder!==null){
            const opt=document.createElement('option');
            opt.value='';
            opt.textContent=placeholder;
            select.appendChild(opt);
        }
        entries.filter(Boolean).forEach(entry=>{
            const opt=document.createElement('option');
            opt.value=entry.value;
            opt.textContent=entry.label || entry.value;
            select.appendChild(opt);
        });
        if(entries.length>0 && entries.some(e=>e && e.value===currentValue)){
            select.value=currentValue;
        }else if(allowEmpty){
            select.value='';
        }else{
            select.value='';
        }
        const placeholderText = placeholder===null?'':placeholder;
        notifySelectOptions(select,{options:entries, placeholder:placeholderText, hasPlaceholder:placeholder!==null});
    }

    function updateValueProxy(id,value){
        const hidden=document.getElementById(id);
        if(!hidden) return;
        const newValue=value??'';
        if(hidden.value===newValue) return;
        hidden.value=newValue;
        hidden.dispatchEvent(new CustomEvent('value-changed',{bubbles:true,detail:{value:newValue}}));
    }

    function getAsyncContainer(id){
        return dynamicForm.querySelector(`.async-select[data-field="${id}"]`);
    }

    function setManualMode(id,mode){
        const container=getAsyncContainer(id);
        if(!container) return;
        const select=container.querySelector('select');
        const manual=container.querySelector(`#${id}-manual`);
        const toggle=container.querySelector('.toggle-manual');
        const required=container.dataset.required==='true';
        if(!manual){
            container.dataset.mode='select';
            select?.classList.remove('hidden');
            if(select && required) select.setAttribute('required','');
            return;
        }
        if(mode==='manual'){
            select?.classList.add('hidden');
            if(select) select.removeAttribute('required');
            select?.setAttribute('aria-hidden','true');
            if(select) select.disabled=true;
            manual.classList.remove('hidden');
            if(required) manual.setAttribute('required',''); else manual.removeAttribute('required');
            if(toggle) toggle.textContent='Aus Liste wählen';
            container.dataset.mode='manual';
            updateValueProxy(id,manual.value?.trim()||'');
        }else{
            manual.classList.add('hidden');
            manual.removeAttribute('required');
            select?.classList.remove('hidden');
            if(select) {
                select.removeAttribute('aria-hidden');
                if(required) select.setAttribute('required','');
                select.disabled = select.options.length===0;
            }
            if(toggle) toggle.textContent='Freitext eingeben';
            container.dataset.mode='select';
            updateValueProxy(id,select?select.value:'');
        }
    }

    async function loadOptionsForField(id){
        const config=asyncSelectConfigs[id];
        if(!config) return;
        const container=getAsyncContainer(id);
        if(!container) return;
        const select=container.querySelector('select');
        const manual=container.querySelector(`#${id}-manual`);
        if(!select) return;
        const dependencyId=config.dependsOn;
        const dependencyValue=dependencyId?document.getElementById(dependencyId)?.value?.trim():undefined;
        if(dependencyId && !dependencyValue){
            select.innerHTML='';
            populateOptions(select,[],{placeholder:'Bitte zuerst die abhängige Auswahl treffen',allowEmpty:true});
            select.disabled=true;
            if(manual){
                manual.value='';
                if(container.dataset.mode!=='manual') updateValueProxy(id,'');
            }
            return;
        }

        const source=asyncSources[config.sourceKey];
        if(!source){
            select.innerHTML='';
            select.disabled=true;
            notifySelectOptions(select,{options:[], placeholder:'', hasPlaceholder:false});
            if(manual){
                manual.value='';
                if(container.dataset.mode!=='manual') updateValueProxy(id,'');
                if(config.allowManual!==false) setManualMode(id,'manual');
            }
            return;
        }

        select.disabled=true;
        select.innerHTML=`<option value="">Lade Daten…</option>`;
        notifySelectOptions(select,{options:[], placeholder:'Lade Daten…', hasPlaceholder:true});
        try{
            const url=typeof source.url==='function'?source.url(dependencyValue):source.url;
            const data=await fetchJson(url);
            let entries=(Array.isArray(data)?data:[]).map(source.map).filter(Boolean);
            if(typeof config.filter==='function'){
                entries=entries.filter(entry=>config.filter(entry, dependencyValue));
            }
            const placeholderText = entries.length===0 ? (config.emptyText||config.placeholder) : config.placeholder;
            populateOptions(select,entries,{placeholder:placeholderText,allowEmpty:!config.required});
            select.disabled=entries.length===0;
            if(container.dataset.mode!=='manual'){
                select.value='';
                updateValueProxy(id,'');
            }
            if(entries.length===0 && config.allowManual!==false){
                if(manual){
                    manual.value='';
                    setManualMode(id,'manual');
                }
            }else if(container.dataset.mode!=='manual'){
                setManualMode(id,'select');
            }
        }catch(err){
            console.error(err);
            populateOptions(select,[],{placeholder:'Fehler beim Laden'});
            select.disabled=true;
            if(config.allowManual!==false){
                setManualMode(id,'manual');
            }
        }
    }

    function initializeAsyncSelects(form){
        Object.keys(asyncSelectConfigs).forEach(id=>{
            const container=form.querySelector(`.async-select[data-field="${id}"]`);
            if(!container) return;
            const select=container.querySelector('select');
            const manual=container.querySelector(`#${id}-manual`);
            const toggle=container.querySelector('.toggle-manual');
            const hidden=form.querySelector(`#${id}`);
            if(hidden) hidden.value='';
            container.dataset.mode='select';
            if(select){
                select.addEventListener('change',()=>{
                    if(container.dataset.mode!=='manual'){
                        updateValueProxy(id,select.value);
                    }
                });
            }
            if(manual){
                manual.addEventListener('input',()=>{
                    if(container.dataset.mode==='manual'){
                        updateValueProxy(id,manual.value.trim());
                    }
                });
            }
            if(toggle){
                toggle.addEventListener('click',()=>{
                    setManualMode(id,container.dataset.mode==='manual'?'select':'manual');
                });
            }
            if(manual && container.dataset.required==='true'){
                manual.removeAttribute('required');
            }
            setManualMode(id,'select');
        });

        Object.entries(asyncSelectConfigs).forEach(([id,config])=>{
            if(config.dependsOn){
                const dep=document.getElementById(config.dependsOn);
                if(dep){
                    dep.addEventListener('value-changed',()=>loadOptionsForField(id));
                }
            }
            loadOptionsForField(id);
        });
    }

    async function ensureAsyncValue(fieldId,value,options={}){
        if(value===undefined || value===null) return;
        const normalized=String(value);
        if(!normalized) return;
        const container=getAsyncContainer(fieldId);
        if(container){
            if(container.dataset.mode==='manual'){
                setManualMode(fieldId,'select');
            }
            const select=container.querySelector('select');
            const manual=container.querySelector(`#${fieldId}-manual`);
            const toggle=container.querySelector('.toggle-manual');
            await loadOptionsForField(fieldId);
            let applied=false;
            if(select){
                const match=Array.from(select.options||[]).find(opt=>opt.value===normalized);
                if(match){
                    select.value=normalized;
                    select.dispatchEvent(new Event('change',{bubbles:true}));
                    applied=true;
                }
            }
            if(!applied && manual){
                setManualMode(fieldId,'manual');
                manual.value=normalized;
                manual.dispatchEvent(new Event('input',{bubbles:true}));
                applied=true;
            }
            if(!applied){
                updateValueProxy(fieldId,normalized);
            }
            if(options.lock){
                if(select){
                    select.disabled=true;
                    select.setAttribute('aria-disabled','true');
                }
                if(manual){
                    manual.disabled=true;
                    manual.setAttribute('aria-disabled','true');
                }
                if(toggle){
                    toggle.disabled=true;
                    toggle.setAttribute('aria-disabled','true');
                    toggle.setAttribute('tabindex','-1');
                }
            }
            return;
        }
        const input=document.getElementById(fieldId);
        if(!input) return;
        input.value=normalized;
        if(options.lock){
            input.readOnly=true;
            input.setAttribute('aria-readonly','true');
        }
    }

    function applyInputEnhancements(form){
        form.querySelectorAll('input[data-uppercase="true"]').forEach(input=>{
            input.addEventListener('input',()=>{
                const start=input.selectionStart;
                const end=input.selectionEnd;
                const upper=input.value.toUpperCase();
                if(input.value!==upper){
                    input.value=upper;
                    if(start!==null && end!==null){
                        input.setSelectionRange(start,end);
                    }
                }
            });
        });
    }

    function buildForm(t){
        const f=dynamicForm; f.dataset.type=t; let h='';
        asyncSelectConfigs = {};
        showEntityMessage(t, {});
        switch(t){
            case 'Account':
                h+= add('name','Name')
                    + add('contact','Kontaktperson')
                    + add('email','E-Mail')
                    + add('phone','Telefon')
                    + add('vat','USt-ID')
                    + add('country','Land');
                break;

            case 'Address':
                h+= add('street','Straße')
                    + renderAsyncSelect('cityID','City auswählen','cities',{allowManual:false, placeholder:'City auswählen'});
                break;

            case 'AudioDevice':
                h+= renderAsyncSelect('client','Client auswählen','clients',{placeholder:'Client auswählen'})
                    + add('brand','Marke')
                    + add('serial','Serien-Nr.')
                    + add('fw','Firmware')
                    + addSel('dtype','DeviceType',['HEADSET','SPEAKER','MIC']);
                break;

            case 'City':
                h+= add('cityId','CityID',{dataset:{uppercase:true}})
                    + add('cityName','City Name')
                    + renderAsyncSelect('countryCode','Country auswählen','countries',{allowManual:false, placeholder:'Land auswählen'});
                break;

            case 'Country':
                h+= add('countryCode','Country Code',{pattern:'[A-Za-z]{2}', maxlength:2, dataset:{uppercase:true}, autocomplete:'off'})
                    + add('countryName','Country Name');
                break;

            case 'DeploymentVariant':
                h+= add('variantCode','VariantCode')
                    + add('variantName','VariantName')
                    + add('description','Description',{required:false})
                    + addSel('active','IsActive',['true','false']);
                break;

            case 'InstalledSoftware':
                h+= renderAsyncSelect('siteID','Site auswählen','sites',{placeholder:'Site auswählen', allowManual:false})
                    + renderAsyncSelect('softwareID','Software auswählen','software',{placeholder:'Software auswählen', allowManual:false});
                break;

            case 'PhoneIntegration':
                h+= renderAsyncSelect('client','Client auswählen','clients',{placeholder:'Client auswählen'})
                    + addSel('type','PhoneType',['Emergency','NonEmergency','Both'])
                    + add('brand','Marke')
                    + add('serial','Serien-Nr.')
                    + add('fw','Firmware');
                break;

            case 'Project':
                h+= add('sap','SAP-ID',{required:false})
                    + add('pname','Projektname')
                    + renderAsyncSelect('variantId','Deployment-Variante auswählen','deploymentVariants',{placeholder:'Deployment-Variante auswählen'})
                    + add('bundle','Bundle-Type',{required:false})
                    + renderAsyncSelect('accId','Account auswählen','accounts')
                    + renderAsyncSelect('addrId','Adresse auswählen','addresses',{allowManual:false, placeholder:'Adresse auswählen'});
                break;

            case 'Radio':
                h+= renderAsyncSelect('siteId','Site auswählen','sites')
                    + add('brand','Marke')
                    + add('serial','Serien-Nr.')
                    + addSel('mode','Mode',['Analog','Digital'])
                    + addSel('standard','Digital-Standard',['Airbus','Motorola','ESN','P25','Polycom','Teltronics'],{required:false})
                    + renderAsyncSelect('client','AssignedClientID (UUID)','clients',{required:false, placeholder:'Client auswählen (optional)', dependsOn:'siteId'});
                break;

            case 'Server':
                h+= renderAsyncSelect('siteId','Site auswählen','sites')
                    + add('name','Servername')
                    + add('brand','Marke')
                    + add('serial','Serien-Nr.')
                    + add('os','Betriebssystem')
                    + add('patch','Patch-Level')
                    + addSel('vplat','Virtual-Platform',['BareMetal','HyperV','vSphere'])
                    + add('vver','Virtual-Version',{required:false})
                    + addSel('ha','HighAvailability',['true','false']);
                break;

            case 'ServiceContract':
                h+= renderAsyncSelect('accountID','Account auswählen','accounts',{placeholder:'Account auswählen', allowManual:false})
                    + renderAsyncSelect('projectID','Projekt auswählen','projects',{placeholder:'Projekt auswählen', allowManual:false, dependsOn:'accountID'})
                    + renderAsyncSelect('siteID','Site auswählen','sites',{placeholder:'Site auswählen', allowManual:false, dependsOn:'projectID', emptyText:'Keine Sites für die Auswahl'})
                    + add('contractNumber','Vertragsnummer')
                    + addSel('status','Status',['Planned','Approved','InProgress','Done','Canceled'])
                    + add('startDate','Startdatum',{type:'date'})
                    + add('endDate','Enddatum',{type:'date'});
                break;

            case 'Site':
                h+= renderAsyncSelect('pId','Project auswählen','projects')
                    + add('name','Site-Name')
                    + renderAsyncSelect('addrId','Adresse auswählen','addresses',{allowManual:false, placeholder:'Adresse auswählen'})
                    + add('zone','FireZone',{required:false})
                    + add('tenant','TenantCount',{type:'number', min:'0', step:'1', required:false});
                break;

            case 'Software':
                h+= add('swName','Name')
                    + add('swRelease','Release')
                    + add('swRevision','Revision')
                    + addSel('swPhase','SupportPhase',['Preview','Production','EoL'])
                    + add('swLicense','License Model',{required:false})
                    + add('swEos','End of Sales',{required:false,type:'date'})
                    + add('swSupportStart','Support Start',{required:false,type:'date'})
                    + add('swSupportEnd','Support End',{required:false,type:'date'});
                break;

            case 'UpgradePlan':
                h+= renderAsyncSelect('siteID','Site auswählen','sites',{placeholder:'Site auswählen', allowManual:false})
                    + renderAsyncSelect('softwareID','Software auswählen','software',{placeholder:'Software auswählen', allowManual:false})
                    + add('plannedStart','Geplanter Start',{type:'date'})
                    + add('plannedEnd','Geplantes Ende',{type:'date'})
                    + addSel('status','Status',['Planned','Approved','InProgress','Done','Canceled'])
                    + add('createdAt','Erstellt am',{type:'date', value:new Date().toISOString().split('T')[0]})
                    + add('createdBy','Erstellt von');
                break;

            case 'WorkingPosition':
                h+= renderAsyncSelect('siteId','Site auswählen','sites')
                    + add('name','Client-Name')
                    + add('brand','Marke')
                    + add('serial','Serien-Nr.')
                    + add('os','OS')
                    + add('patch','Patch-Level')
                    + addSel('install','InstallType',['LOCAL','BROWSER']);
                break;
        }
        f.innerHTML = h + `<button>Speichern</button> <button type="button" onclick="back()">Zurück</button>`;
        initializeAsyncSelects(f);
        if(window.enhanceSelectFiltering){
            window.enhanceSelectFiltering(f);
        }
        applyInputEnhancements(f);
        if(t==='Radio') wireRadioLogic();
    }

    function wireRadioLogic(){
        const m = document.getElementById('mode');
        const s = document.getElementById('standard');
        if(!m || !s) return;
        const update = ()=>{
            const disable = (m.value==='Analog');
            s.disabled = disable;
            if(disable){ s.value=''; }
        };
        m.addEventListener('change', update);
        update();
    }

    const v=id=>document.getElementById(id)?.value?.trim();
    const toNull=value=>value && value.length>0 ? value : null;

    async function initializeFromQuery(){
        const params=new URLSearchParams(window.location.search);
        const rawEntity=params.get('entity');
        if(!rawEntity) return;
        const entitySelect=document.getElementById('entity');
        if(!entitySelect) return;
        const option=Array.from(entitySelect.options).find(opt=>opt.value.toLowerCase()===rawEntity.toLowerCase());
        if(!option) return;
        entitySelect.value=option.value;
        buildForm(option.value);
        step1.classList.add('hidden');
        dynamicForm.classList.remove('hidden');

        const context={};
        const accountId=params.get('accountId');
        const projectId=params.get('projectId');
        const siteId=params.get('siteId');
        const clientId=params.get('clientId');

        switch(option.value){
            case 'Project':
                if(accountId){
                    await ensureAsyncValue('accId', accountId, {lock:true});
                    context.accountId=accountId;
                }
                break;
            case 'Site':
                if(accountId) context.accountId=accountId;
                if(projectId){
                    await ensureAsyncValue('pId', projectId, {lock:true});
                    context.projectId=projectId;
                }
                break;
            case 'Server':
            case 'WorkingPosition':
            case 'Radio':
                if(accountId) context.accountId=accountId;
                if(projectId) context.projectId=projectId;
                if(siteId){
                    await ensureAsyncValue('siteId', siteId, {lock:true});
                    context.siteId=siteId;
                }
                break;
            case 'AudioDevice':
            case 'PhoneIntegration':
                if(accountId) context.accountId=accountId;
                if(projectId) context.projectId=projectId;
                if(siteId) context.siteId=siteId;
                if(clientId){
                    await ensureAsyncValue('client', clientId, {lock:true});
                    context.clientId=clientId;
                }
                break;
            case 'ServiceContract':
                if(accountId){
                    await ensureAsyncValue('accountID', accountId, {lock:true});
                    context.accountId=accountId;
                }
                if(projectId){
                    await ensureAsyncValue('projectID', projectId, {lock:true});
                    context.projectId=projectId;
                }
                if(siteId){
                    await ensureAsyncValue('siteID', siteId, {lock:true});
                    context.siteId=siteId;
                }
                break;
        }

        showEntityMessage(option.value, context);
    }

    async function submitForm(e){
        e.preventDefault();
        const t=e.target.dataset.type; result.textContent=''; result.setAttribute('aria-busy','true');
        const fail=msg=>{
            result.innerHTML=`<p class="error" role="alert">${msg}</p>`;
            result.removeAttribute('aria-busy');
            return true;
        };
        let url='',p={};

        switch(t){
            case 'Account':
                url='/accounts';
                p={
                    accountName: v('name'),
                    contactName: toNull(v('contact')),
                    contactEmail: toNull(v('email')),
                    contactPhone: toNull(v('phone')),
                    vatNumber: toNull(v('vat')),
                    country: toNull(v('country'))
                };
                break;

            case 'Address':
                url='/addresses';
                p={
                    street: v('street'),
                    cityID: v('cityID')
                };
                break;

            case 'Project':
                url='/projects';
                p={
                    projectSAPID: toNull(v('sap')),
                    projectName: v('pname'),
                    deploymentVariantID: v('variantId'),
                    bundleType: toNull(v('bundle')),
                    accountID: v('accId'),
                    addressID: v('addrId')
                };
                break;

            case 'Site':
                url='/sites';
                const tenantRaw=v('tenant');
                const tenantCount=tenantRaw ? Number(tenantRaw) : null;
                if(tenantRaw && Number.isNaN(tenantCount)){
                    fail('TenantCount muss eine Zahl sein.');
                    return;
                }
                p={
                    projectID: v('pId'),
                    siteName: v('name'),
                    addressID: v('addrId'),
                    fireZone: toNull(v('zone')),
                    tenantCount
                };
                break;

            case 'Server':
                url='/servers';
                p={
                    siteID: v('siteId'),
                    serverName: v('name'),
                    serverBrand: toNull(v('brand')),
                    serverSerialNr: toNull(v('serial')),
                    serverOS: toNull(v('os')),
                    patchLevel: toNull(v('patch')),
                    virtualPlatform: v('vplat'),
                    virtualVersion: toNull(v('vver')),
                    highAvailability: v('ha') === 'true'
                };
                break;

            case 'WorkingPosition': // -> Clients
                url='/clients';
                p={
                    siteID: v('siteId'),
                    clientName: v('name'),
                    clientBrand: toNull(v('brand')),
                    clientSerialNr: toNull(v('serial')),
                    clientOS: toNull(v('os')),
                    patchLevel: toNull(v('patch')),
                    installType: v('install')
                };
                break;

            case 'Radio':
                url='/radios';
                p={
                    siteID: v('siteId'),
                    radioBrand: toNull(v('brand')),
                    radioSerialNr: toNull(v('serial')),
                    mode: v('mode'),
                    digitalStandard: toNull(v('standard')),
                    assignedClientID: toNull(v('client'))
                };
                break;

            case 'AudioDevice':
                url='/audio';
                p={
                    clientID: v('client'),
                    audioDeviceBrand: toNull(v('brand')),
                    deviceSerialNr: toNull(v('serial')),
                    audioDeviceFirmware: toNull(v('fw')),
                    deviceType: v('dtype')
                };
                break;

            case 'PhoneIntegration':
                url='/phones';
                p={
                    clientID: v('client'),
                    phoneType: v('type'),
                    phoneBrand: toNull(v('brand')),
                    phoneSerialNr: toNull(v('serial')),
                    phoneFirmware: toNull(v('fw'))
                };
                break;

            case 'DeploymentVariant':
                url='/deployment-variants';
                p={
                    variantCode: v('variantCode'),
                    variantName: v('variantName'),
                    description: toNull(v('description')),
                    active: v('active') === 'true'
                };
                break;

            case 'Country':
                url='/row/country';
                const countryCode=(v('countryCode')||'').toUpperCase();
                if(countryCode.length!==2){
                    fail('Country Code muss genau 2 Zeichen haben.');
                    return;
                }
                p={
                    CountryCode: countryCode,
                    CountryName: v('countryName')
                };
                break;

            case 'City':
                url='/row/city';
                const cityId=(v('cityId')||'').toUpperCase();
                const country=v('countryCode');
                if(!country){
                    fail('Bitte ein Land auswählen.');
                    return;
                }
                p={
                    CityID: cityId,
                    CityName: v('cityName'),
                    CountryCode: country
                };
                break;

            case 'InstalledSoftware':
                url='/row/installedsoftware';
                p={
                    SiteID: v('siteID'),
                    SoftwareID: v('softwareID')
                };
                break;

            case 'Software':
                url='/row/software';
                p={
                    Name: v('swName'),
                    Release: v('swRelease'),
                    Revision: v('swRevision'),
                    SupportPhase: v('swPhase'),
                    LicenseModel: toNull(v('swLicense')),
                    EndOfSalesDate: toNull(v('swEos')),
                    SupportStartDate: toNull(v('swSupportStart')),
                    SupportEndDate: toNull(v('swSupportEnd'))
                };
                break;

            case 'UpgradePlan':
                url='/row/upgradeplan';
                const plannedStart=v('plannedStart');
                const plannedEnd=v('plannedEnd');
                if(plannedStart && plannedEnd && plannedStart>plannedEnd){
                    fail('Das geplante Ende muss nach dem Start liegen.');
                    return;
                }
                p={
                    SiteID: v('siteID'),
                    SoftwareID: v('softwareID'),
                    PlannedWindowStart: plannedStart,
                    PlannedWindowEnd: plannedEnd,
                    Status: v('status'),
                    CreatedAt: v('createdAt'),
                    CreatedBy: v('createdBy')
                };
                break;

            case 'ServiceContract':
                url='/row/servicecontract';
                const startDate=v('startDate');
                const endDate=v('endDate');
                if(startDate && endDate && startDate>endDate){
                    fail('Enddatum darf nicht vor dem Startdatum liegen.');
                    return;
                }
                p={
                    AccountID: v('accountID'),
                    ProjectID: v('projectID'),
                    SiteID: v('siteID'),
                    ContractNumber: v('contractNumber'),
                    Status: v('status'),
                    StartDate: startDate,
                    EndDate: endDate
                };
                break;
        }

        if(!url){
            fail('Unbekannte Entität oder fehlende URL.');
            return;
        }

        try{
            const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)});
            if(r.ok){
                result.innerHTML=`<p class="success">✔ ${t} angelegt.</p>`;
                e.target.reset();
                const ids=Object.keys(asyncSelectConfigs);
                for(const id of ids){
                    await loadOptionsForField(id);
                }
            }
            else   {result.innerHTML=`<p class="error" role="alert">${await r.text()}</p>`;}
        }catch{
            result.innerHTML=`<p class="error" role="alert">Netzwerkfehler.</p>`;
        }finally{
            result.removeAttribute('aria-busy');
        }
    }

    initializeFromQuery().catch(err=>console.error(err));
</script>
</body>
</html>
