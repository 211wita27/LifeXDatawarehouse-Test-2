<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Detailansicht</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .section{margin-top:1.2rem}
        .section h2{margin:.2rem 0 .6rem 0;display:flex;align-items:center;gap:.6rem;flex-wrap:wrap}
        .pill{
            display:inline-block;background:#e9f1ff;border:1px solid #cfe0ff;border-radius:999px;
            padding:.15rem .55rem;margin:.12rem .2rem;cursor:pointer;text-decoration:none;color:inherit
        }
        .pill:hover{background:#dbeaff}
        .empty{color:#666}
        .sep{margin:0 .35rem;color:#999}
        .section h2 .count{color:#6b7280;font-size:.9rem;font-weight:400}
        .add-link{
            display:inline-flex;align-items:center;justify-content:center;
            width:1.8rem;height:1.8rem;border-radius:999px;border:1px solid #2c64b5;
            color:#2c64b5;text-decoration:none;font-weight:600;font-size:1.2rem;line-height:1;
            transition:background .2s ease,color .2s ease;
        }
        .section h2 .add-link{margin-left:auto}
        .add-link:focus,.add-link:hover{background:#2c64b5;color:#fff;outline:2px solid transparent;outline-offset:2px;box-shadow:0 0 0 2px rgba(44,100,181,.35)}
    </style>
</head>
<body>

<a href="#main" class="skip-link">Zum Inhalt springen</a>

<header>
    <img src="/img/LifeXDatawarehouseLogo.png" alt="">
    <nav aria-label="Hauptnavigation">
        <a href="/index.html">Dashboard</a>
        <a href="/create.html">Daten anlegen</a>
        <a href="/reports.html">Reports</a>
    </nav>
</header>

<main id="main" style="max-width:1000px;margin:2rem auto">
    <a id="back" href="index.html">← zurück</a>
    <div id="view" class="card" role="region" aria-live="polite" aria-busy="true">lade …</div>

    <!-- NEU: Eltern-Beziehungen -->
    <div id="parents"></div>

    <!-- Kinder-Listen -->
    <div id="children"></div>
</main>

<script>
    /* -------------------- Helpers -------------------- */
    function escapeHtml(value){
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;',
        };
        return (value ?? '').toString().replace(/[&<>"']/g, c => map[c] ?? c);
    }
    function shortId(value){
        const str = (value ?? '').toString().trim();
        if(!str) return '';
        const uuidPattern = /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;
        if(uuidPattern.test(str)){
            const idx = str.lastIndexOf('-');
            if(idx !== -1 && idx < str.length - 1){
                const lastSegment = str.slice(idx + 1).replace(/^0+/, '');
                const compact = lastSegment || '0';
                return `#${compact}`;
            }
        }
        return str.startsWith('#') ? str : `#${str}`;
    }
    function formatIdChip(id){
        const full = (id ?? '').toString().trim();
        if(!full) return '';
        const display = shortId(full);
        return `<span class="id-chip" title="${escapeHtml(full)}">${escapeHtml(display)}</span>`;
    }
    function tableForType(t){
        const s=(t||'').toLowerCase();
        switch(s){
            case 'account': return 'Account';
            case 'project': return 'Project';
            case 'site': return 'Site';
            case 'server': return 'Server';
            case 'client': return 'Clients'; // geändert von WorkingPosition
            case 'radio': return 'Radio';
            case 'audio': return 'AudioDevice';
            case 'phone': return 'PhoneIntegration';
            case 'country': return 'Country';
            case 'city': return 'City';
            case 'address': return 'Address';
            case 'deploymentvariant': return 'DeploymentVariant';
            case 'software': return 'Software';
            case 'installedsoftware': return 'InstalledSoftware';
            case 'upgradeplan': return 'UpgradePlan';
            case 'servicecontract': return 'ServiceContract';
            default: return t;
        }
    }
    function val(row, ...keys){
        for(const k of keys){
            if (row[k] !== undefined) return row[k];
            const u = k.toUpperCase(), l = k.toLowerCase();
            for (const kk in row) {
                if (kk === u || kk === l) return row[kk];
            }
        }
        return undefined;
    }
    function formatDateLabel(value){
        if (value === null || value === undefined) return '';
        const str = ('' + value).trim();
        if (!str) return '';
        const ts = Date.parse(str);
        if (!Number.isNaN(ts)) {
            return new Date(ts).toLocaleDateString('de-AT', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }
        return str;
    }
    function formatDateRange(start, end){
        const from = formatDateLabel(start);
        const to = formatDateLabel(end);
        if (from && to) return `${from} → ${to}`;
        return from || to || '';
    }
    function labelFor(type, row){
        switch((type||'').toLowerCase()){
            case 'account': return `${val(row,'AccountName') ?? 'Account'}`;
            case 'project': return `${val(row,'ProjectName') ?? 'Project'}`;
            case 'site':    return `${val(row,'SiteName') ?? 'Site'}`;
            case 'server':  return `${val(row,'ServerName') ?? 'Server'}`;
            case 'client':
            case 'clients': return `${val(row,'ClientName') ?? 'Client'}`;
            case 'radio':   return `${val(row,'RadioBrand') ?? 'Radio'}`;
            case 'audio':   return `${val(row,'AudioDeviceBrand') ?? 'AudioDevice'}`;
            case 'phone':   return `${val(row,'PhoneBrand') ?? 'Phone'}`;
            case 'country': return `${val(row,'CountryName') ?? val(row,'CountryCode') ?? 'Country'}`;
            case 'city':    return `${val(row,'CityName') ?? 'City'}`;
            case 'address': return `${val(row,'Street') ?? 'Address'}`;
            case 'deploymentvariant': return `${val(row,'VariantName') ?? 'DeploymentVariant'}`;
            case 'software': return `${val(row,'Name') ?? 'Software'}`;
            case 'installedsoftware': return `${val(row,'InstalledSoftwareID') ?? 'InstalledSoftware'}`;
            case 'upgradeplan': return `${val(row,'UpgradePlanID') ?? 'UpgradePlan'}`;
            case 'servicecontract': return `${val(row,'ContractNumber') ?? 'ServiceContract'}`;
            default:        return '';
        }
    }
    async function fetchJson(url){
        const res = await fetch(url);
        if(!res.ok) return null;
        return res.json();
    }
    function pillLink(href, label, id, description){
        const a = document.createElement('a');
        a.className = 'pill';
        a.href = href;
        const labelHtml = label ? escapeHtml(label) : '';
        const chipHtml = formatIdChip(id);
        const descHtml = (description ?? '').toString().trim();
        const safeDesc = descHtml ? escapeHtml(descHtml) : '';
        let html = '';
        if(labelHtml) html += labelHtml;
        if(chipHtml){
            html += (html ? ' ' : '') + chipHtml;
        }
        if(safeDesc){
            html += (html ? ' – ' : '') + safeDesc;
        }
        if(!html){
            html = escapeHtml(href);
        }
        a.innerHTML = html;
        return a;
    }
    function buildCreateHref(meta){
        if(!meta || !meta.entity) return null;
        const params = new URLSearchParams();
        params.set('entity', meta.entity);
        const entries = meta.params && typeof meta.params === 'object' ? Object.entries(meta.params) : [];
        entries.forEach(([key,value])=>{
            if(value!==undefined && value!==null && value!==''){
                params.set(key, value);
            }
        });
        const query = params.toString();
        return `create.html${query ? `?${query}` : ''}`;
    }
    function describeCreateMeta(meta){
        if(!meta) return '';
        const label = meta.label || meta.entity || '';
        const contextParts = [];
        const ctx = meta.params || {};
        if(ctx.accountId) contextParts.push(`Account ${shortId(ctx.accountId).replace(/^##/, '#')}`);
        if(ctx.projectId) contextParts.push(`Project ${shortId(ctx.projectId).replace(/^##/, '#')}`);
        if(ctx.siteId) contextParts.push(`Site ${shortId(ctx.siteId).replace(/^##/, '#')}`);
        if(ctx.clientId) contextParts.push(`Client ${shortId(ctx.clientId).replace(/^##/, '#')}`);
        if(contextParts.length){
            return `Neuen ${label} für ${contextParts.join(' und ')} anlegen`;
        }
        return `Neuen ${label} anlegen`;
    }
    function addSection(container, title, items, toLink, createMeta){
        const list = Array.isArray(items) ? items : [];
        const sec = document.createElement('div');
        sec.className = 'section';
        const heading = document.createElement('h2');
        heading.innerHTML = `${escapeHtml(title)} <span class="count">(${list.length})</span>`;
        if(createMeta){
            const href = buildCreateHref(createMeta);
            if(href){
                const addLink = document.createElement('a');
                addLink.className = 'add-link';
                addLink.href = href;
                const aria = describeCreateMeta(createMeta);
                addLink.setAttribute('aria-label', aria);
                addLink.title = aria;
                addLink.textContent = '+';
                heading.appendChild(addLink);
            }
        }
        sec.appendChild(heading);
        if(!list.length){
            const empty = document.createElement('div');
            empty.className = 'empty';
            empty.textContent = '(keine Einträge)';
            sec.appendChild(empty);
            container.appendChild(sec);
            return;
        }
        const wrap = document.createElement('div');
        list.forEach(it => wrap.appendChild(toLink(it)));
        sec.appendChild(wrap);
        container.appendChild(sec);
    }

    /* -------------------- Eltern laden -------------------- */
    async function loadParents(type, id, row){
        const box = document.getElementById('parents');
        box.innerHTML = '';

        // Hilfsfunktionen für Row-Fetches
        const rowAccount = async (accountId) => await fetchJson(`/row/Account/${accountId}`);
        const rowProject = async (projectId) => await fetchJson(`/row/Project/${projectId}`);
        const rowSite    = async (siteId)    => await fetchJson(`/row/Site/${siteId}`);
        const rowClient  = async (clientId)  => await fetchJson(`/row/Clients/${clientId}`); // geändert

        const sections = [];

        if (type === 'Project') {
            const accId = val(row,'AccountID');
            if (accId != null) {
                const acc = await rowAccount(accId);
                if (acc) sections.push({
                    title: 'Gehört zu',
                    pills: [ pillLink(`/details.html?type=account&id=${accId}`, 'Account', accId, labelFor('account', acc)) ]
                });
            }
        } else if (type === 'Site') {
            const projId = val(row,'ProjectID');
            if (projId != null) {
                const proj = await rowProject(projId);
                const pills = [];
                if (proj) {
                    pills.push(pillLink(`/details.html?type=project&id=${projId}`, 'Project', projId, labelFor('project', proj)));
                    const accId = val(proj,'AccountID');
                    if (accId != null) {
                        const acc = await rowAccount(accId);
                        if (acc) pills.push(pillLink(`/details.html?type=account&id=${accId}`, 'Account', accId, labelFor('account', acc)));
                    }
                }
                if (pills.length) sections.push({ title: 'Gehört zu', pills });
            }
        } else if (type === 'Server') {
            const siteId = val(row,'SiteID');
            if (siteId != null) {
                const site = await rowSite(siteId);
                const pills = [];
                if (site) {
                    pills.push(pillLink(`/details.html?type=site&id=${siteId}`, 'Site', siteId, labelFor('site', site)));
                    const projId = val(site,'ProjectID');
                    if (projId != null) {
                        const proj = await rowProject(projId);
                        if (proj) {
                            pills.push(pillLink(`/details.html?type=project&id=${projId}`, 'Project', projId, labelFor('project', proj)));
                            const accId = val(proj,'AccountID');
                            if (accId != null) {
                                const acc = await rowAccount(accId);
                                if (acc) pills.push(pillLink(`/details.html?type=account&id=${accId}`, 'Account', accId, labelFor('account', acc)));
                            }
                        }
                    }
                }
                if (pills.length) sections.push({ title: 'Gehört zu', pills });
            }
        } else if (type === 'Client') {
            const siteId = val(row,'SiteID');
            if (siteId != null) {
                const site = await rowSite(siteId);
                const pills = [];
                if (site) {
                    pills.push(pillLink(`/details.html?type=site&id=${siteId}`, 'Site', siteId, labelFor('site', site)));
                    const projId = val(site,'ProjectID');
                    if (projId != null) {
                        const proj = await rowProject(projId);
                        if (proj) {
                            pills.push(pillLink(`/details.html?type=project&id=${projId}`, 'Project', projId, labelFor('project', proj)));
                            const accId = val(proj,'AccountID');
                            if (accId != null) {
                                const acc = await rowAccount(accId);
                                if (acc) pills.push(pillLink(`/details.html?type=account&id=${accId}`, 'Account', accId, labelFor('account', acc)));
                            }
                        }
                    }
                }
                if (pills.length) sections.push({ title: 'Gehört zu', pills });
            }
        } else if (type === 'City') {
            const countryCode = val(row, 'CountryCode');
            if (countryCode != null) {
                const country = await fetchJson(`/row/Country/${countryCode}`);
                if (country) {
                    const pill = pillLink(
                        `/details.html?type=country&id=${encodeURIComponent(countryCode)}`,
                        'Country',
                        countryCode,
                        labelFor('country', country)
                    );
                    sections.push({ title: 'Gehört zu', pills: [pill] });
                }
            }
        } else if (type === 'Radio') {
            const pills = [];
            const siteId = val(row,'SiteID');
            if (siteId != null) {
                const site = await rowSite(siteId);
                if (site) {
                    pills.push(pillLink(`/details.html?type=site&id=${siteId}`, 'Site', siteId, labelFor('site', site)));
                    const projId = val(site,'ProjectID');
                    if (projId != null) {
                        const proj = await rowProject(projId);
                        if (proj) {
                            pills.push(pillLink(`/details.html?type=project&id=${projId}`, 'Project', projId, labelFor('project', proj)));
                            const accId = val(proj,'AccountID');
                            if (accId != null) {
                                const acc = await rowAccount(accId);
                                if (acc) pills.push(pillLink(`/details.html?type=account&id=${accId}`, 'Account', accId, labelFor('account', acc)));
                            }
                        }
                    }
                }
            }
            const clientId = val(row,'AssignedClientID');
            if (clientId != null) {
                const client = await rowClient(clientId);
                if (client) pills.push(pillLink(`/details.html?type=client&id=${clientId}`, 'Client', clientId, labelFor('client', client)));
            }
            if (pills.length) sections.push({ title: 'Gehört zu', pills });
        } else if (type === 'Audio') {
            const clientId = val(row,'ClientID');
            if (clientId != null) {
                const client = await rowClient(clientId);
                const pills = [];
                if (client) {
                    pills.push(pillLink(`/details.html?type=client&id=${clientId}`, 'Client', clientId, labelFor('client', client)));
                    const siteId = val(client,'SiteID');
                    if (siteId != null) {
                        const site = await rowSite(siteId);
                        if (site) {
                            pills.push(pillLink(`/details.html?type=site&id=${siteId}`, 'Site', siteId, labelFor('site', site)));
                            const projId = val(site,'ProjectID');
                            if (projId != null) {
                                const proj = await rowProject(projId);
                                if (proj) {
                                    pills.push(pillLink(`/details.html?type=project&id=${projId}`, 'Project', projId, labelFor('project', proj)));
                                    const accId = val(proj,'AccountID');
                                    if (accId != null) {
                                        const acc = await rowAccount(accId);
                                        if (acc) pills.push(pillLink(`/details.html?type=account&id=${accId}`, 'Account', accId, labelFor('account', acc)));
                                    }
                                }
                            }
                        }
                    }
                }
                if (pills.length) sections.push({ title: 'Gehört zu', pills });
            }
        } else if (type === 'Phone') {
            const clientId = val(row,'ClientID');
            if (clientId != null) {
                const client = await rowClient(clientId);
                const pills = [];
                if (client) {
                    pills.push(pillLink(`/details.html?type=client&id=${clientId}`, 'Client', clientId, labelFor('client', client)));
                    const siteId = val(client,'SiteID');
                    if (siteId != null) {
                        const site = await rowSite(siteId);
                        if (site) {
                            pills.push(pillLink(`/details.html?type=site&id=${siteId}`, 'Site', siteId, labelFor('site', site)));
                            const projId = val(site,'ProjectID');
                            if (projId != null) {
                                const proj = await rowProject(projId);
                                if (proj) {
                                    pills.push(pillLink(`/details.html?type=project&id=${projId}`, 'Project', projId, labelFor('project', proj)));
                                    const accId = val(proj,'AccountID');
                                    if (accId != null) {
                                        const acc = await rowAccount(accId);
                                        if (acc) pills.push(pillLink(`/details.html?type=account&id=${accId}`, 'Account', accId, labelFor('account', acc)));
                                    }
                                }
                            }
                        }
                    }
                }
                if (pills.length) sections.push({ title: 'Gehört zu', pills });
            }
        } else if (type === 'ServiceContract') {
            const pills = [];
            const accId = val(row,'AccountID');
            if (accId != null) {
                const acc = await rowAccount(accId);
                if (acc) pills.push(pillLink(`/details.html?type=account&id=${accId}`, 'Account', accId, labelFor('account', acc)));
            }
            const projId = val(row,'ProjectID');
            if (projId != null) {
                const proj = await rowProject(projId);
                if (proj) pills.push(pillLink(`/details.html?type=project&id=${projId}`, 'Project', projId, labelFor('project', proj)));
            }
            const siteId = val(row,'SiteID');
            if (siteId != null) {
                const site = await rowSite(siteId);
                if (site) pills.push(pillLink(`/details.html?type=site&id=${siteId}`, 'Site', siteId, labelFor('site', site)));
            }
            if (pills.length) sections.push({ title: 'Gehört zu', pills });
        }

        // Rendern
        if (sections.length){
            sections.forEach(s => {
                const sec = document.createElement('div');
                sec.className = 'section';
                sec.innerHTML = `<h2>${s.title}</h2>`;
                const wrap = document.createElement('div');
                s.pills.forEach(p => wrap.appendChild(p));
                sec.appendChild(wrap);
                box.appendChild(sec);
            });
        }
    }

    /* -------------------- Kinder laden -------------------- */
    async function loadChildren(type, id, row){
        row = row || {};
        const box = document.getElementById('children');
        box.innerHTML = '';

        const loadServiceContracts = async (filterKey, value) => {
            if (!value) return [];
            const rows = await fetchJson(`/table/servicecontract?limit=200`);
            if (!Array.isArray(rows)) return [];
            return rows.filter(r => (val(r, filterKey) ?? '').toString() === value.toString());
        };

        if(type==='Account'){
            const projects = await fetchJson(`/projects?accountId=${id}`);
            addSection(box, 'Projects', projects, p => {
                const pid = val(p,'ProjectID');
                const name = val(p,'ProjectName');
                return pillLink(`/details.html?type=project&id=${encodeURIComponent(pid)}`, null, pid, name);
            }, { entity: 'Project', label: 'Project', params: { accountId: id } });

            const contracts = await loadServiceContracts('AccountID', id);
            addSection(box, 'Service Contracts', contracts, sc => {
                const cid = val(sc,'ContractID');
                const label = val(sc,'ContractNumber');
                const status = val(sc,'Status');
                const meta = formatDateRange(val(sc,'StartDate'), val(sc,'EndDate'));
                const desc = [status, meta].filter(Boolean).join(' · ');
                return pillLink(`/details.html?type=servicecontract&id=${encodeURIComponent(cid)}`, labelFor('servicecontract', sc), cid, desc);
            }, { entity: 'ServiceContract', label: 'ServiceContract', params: { accountId: id } });
        }
        else if(type==='Project'){
            const sites = await fetchJson(`/sites?projectId=${id}`);
            addSection(box, 'Sites', sites, s => {
                const sid = val(s,'SiteID');
                const name = val(s,'SiteName');
                return pillLink(`/details.html?type=site&id=${encodeURIComponent(sid)}`, null, sid, name);
            }, { entity: 'Site', label: 'Site', params: { projectId: id } });

            const contracts = await loadServiceContracts('ProjectID', id);
            addSection(box, 'Service Contracts', contracts, sc => {
                const cid = val(sc,'ContractID');
                const label = val(sc,'ContractNumber');
                const status = val(sc,'Status');
                const meta = formatDateRange(val(sc,'StartDate'), val(sc,'EndDate'));
                const desc = [status, meta].filter(Boolean).join(' · ');
                return pillLink(`/details.html?type=servicecontract&id=${encodeURIComponent(cid)}`, labelFor('servicecontract', sc), cid, desc);
            }, { entity: 'ServiceContract', label: 'ServiceContract', params: { accountId: val(row,'AccountID'), projectId: id } });
        }
        else if(type==='Site'){
            let projectId = val(row,'ProjectID');
            let accountId = val(row,'AccountID');
            if(!accountId && projectId){
                const projectRow = await fetchJson(`/row/Project/${encodeURIComponent(projectId)}`);
                if(projectRow) accountId = val(projectRow,'AccountID');
            }

            const servers = await fetchJson(`/servers?siteId=${id}`);
            addSection(box, 'Server', servers, s => {
                const sid = val(s,'ServerID');
                const name = val(s,'ServerName');
                return pillLink(`/details.html?type=server&id=${encodeURIComponent(sid)}`, null, sid, name);
            }, { entity: 'Server', label: 'Server', params: { accountId, projectId, siteId: id } });

            const clients = await fetchJson(`/clients?siteId=${id}`);
            addSection(box, 'Clients', clients, c => {
                const cid = val(c,'ClientID');
                const name = val(c,'ClientName');
                return pillLink(`/details.html?type=client&id=${encodeURIComponent(cid)}`, null, cid, name);
            }, { entity: 'WorkingPosition', label: 'Client', params: { accountId, projectId, siteId: id } });

            const radios = await fetchJson(`/radios?siteId=${id}`);
            addSection(box, 'Radios', radios, r => {
                const rid = val(r,'RadioID');
                const brand = val(r,'RadioBrand');
                return pillLink(`/details.html?type=radio&id=${encodeURIComponent(rid)}`, null, rid, brand);
            }, { entity: 'Radio', label: 'Radio', params: { accountId, projectId, siteId: id } });

            const contracts = await loadServiceContracts('SiteID', id);
            addSection(box, 'Service Contracts', contracts, sc => {
                const cid = val(sc,'ContractID');
                const label = val(sc,'ContractNumber');
                const status = val(sc,'Status');
                const meta = formatDateRange(val(sc,'StartDate'), val(sc,'EndDate'));
                const desc = [status, meta].filter(Boolean).join(' · ');
                return pillLink(`/details.html?type=servicecontract&id=${encodeURIComponent(cid)}`, labelFor('servicecontract', sc), cid, desc);
            }, { entity: 'ServiceContract', label: 'ServiceContract', params: { accountId, projectId, siteId: id } });
        }
        else if(type==='Client'){
            const aud = await fetchJson(`/audio?clientId=${id}`);
            addSection(box, 'Audio Devices', aud, a => {
                const aid = val(a,'AudioDeviceID');
                const brand = val(a,'AudioDeviceBrand');
                return pillLink(`/details.html?type=audio&id=${encodeURIComponent(aid)}`, null, aid, brand);
            }, { entity: 'AudioDevice', label: 'AudioDevice', params: { clientId: id, siteId: val(row,'SiteID') } });

            const ph = await fetchJson(`/phones?clientId=${id}`);
            addSection(box, 'Phone Integrations', ph, p => {
                const pid = val(p,'PhoneIntegrationID');
                const brand = val(p,'PhoneBrand');
                return pillLink(`/details.html?type=phone&id=${encodeURIComponent(pid)}`, null, pid, brand);
            }, { entity: 'PhoneIntegration', label: 'PhoneIntegration', params: { clientId: id, siteId: val(row,'SiteID') } });
        }
        else if(type==='Software'){
            const installedRows = await fetchJson(`/table/installedsoftware?limit=200`);
            const installed = Array.isArray(installedRows)
                ? installedRows.filter(r => (val(r,'SoftwareID') ?? '').toString() === id.toString())
                : [];
            addSection(box, 'Installationen', installed, isw => {
                const installId = val(isw,'InstalledSoftwareID');
                const label = labelFor('installedsoftware', isw);
                const siteId = val(isw,'SiteID');
                const descParts = [];
                if(siteId){
                    descParts.push(`Site ${shortId(siteId)}`);
                }
                return pillLink(`/details.html?type=installedsoftware&id=${encodeURIComponent(installId)}`, label, installId, descParts.join(' · '));
            });

            const planRows = await fetchJson(`/table/upgradeplan?limit=200`);
            const plans = Array.isArray(planRows)
                ? planRows.filter(r => (val(r,'SoftwareID') ?? '').toString() === id.toString())
                : [];
            addSection(box, 'Upgrade-Pläne', plans, plan => {
                const planId = val(plan,'UpgradePlanID');
                const label = labelFor('upgradeplan', plan);
                const status = val(plan,'Status');
                const window = formatDateRange(val(plan,'PlannedWindowStart'), val(plan,'PlannedWindowEnd'));
                const descParts = [status, window].filter(Boolean);
                return pillLink(`/details.html?type=upgradeplan&id=${encodeURIComponent(planId)}`, label, planId, descParts.join(' · '));
            });
        }
    }

    /* -------------------- Boot -------------------- */
    (async () => {
        const p = new URLSearchParams(location.search);
        const rawType = p.get('type');
        const id = p.get('id');
        const box = document.getElementById('view');

        if(!rawType || !id){ box.textContent = 'Parameter fehlen.'; box.removeAttribute('aria-busy'); return; }

        const table = tableForType(rawType);
        try{
            const res = await fetch(`/row/${table}/${id}`);
            if(!res.ok){ box.textContent = 'Eintrag nicht gefunden.'; box.removeAttribute('aria-busy'); return; }
            const row = await res.json();

            const kvRows = Object.entries(row)
                .map(([k,v])=>`<tr><th scope="row" class="key">${k}</th><td>${v}</td></tr>`).join('');
            const typeLabelRaw = rawType || table || '';
            const baseLabel = typeLabelRaw ? typeLabelRaw.charAt(0).toUpperCase() + typeLabelRaw.slice(1) : 'Eintrag';
            const headingLabel = escapeHtml(baseLabel);
            const idChip = formatIdChip(id);
            const captionIdRaw = (id ?? '').toString().trim();
            const captionText = captionIdRaw ? `${baseLabel} ${captionIdRaw.startsWith('#') ? captionIdRaw : `#${captionIdRaw}`}` : baseLabel;

            box.innerHTML = `<h1>${idChip ? `${headingLabel} ${idChip}` : headingLabel}</h1>
<table id="kv">
  <caption class="visually-hidden">Felder von ${escapeHtml(captionText)}</caption>
  ${kvRows}
</table>`;

            const typeKey = (table==='Clients') ? 'Client' : table; // geändert

            await loadParents(typeKey, id, row);
            await loadChildren(typeKey, id, row);

        }catch(e){
            box.textContent = 'Fehler: ' + e;
        } finally {
            box.removeAttribute('aria-busy');
        }
    })();
</script>
</body>
</html>
